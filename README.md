# YKVM Staff MIS

![YKVM Logo](./public/ykvm-logo.png)

## Overview

**YKVM Staff MIS** is a staff management information system for **Yuva Kaushal Vikas Mandal (YKVM)**.  The goal of this project is to provide a single web‑and‑mobile Progressive Web App (PWA) that enables YKVM administrators and staff to manage the entire employee lifecycle — from onboarding to attendance, field reporting, leaves, payroll and travel allowances.  The app is built with **Next.js** using the **App Router**, **TypeScript**, **Tailwind CSS**, **Prisma** and **NextAuth** and is designed to work offline on Android phones as well as desktop browsers.

This repository contains a complete implementation of the required data models, authentication and role‑based access control, API routes for core business processes, PDF/QR code generation, and a service worker for offline support.  A seed script creates a default admin user and office location for local development.

### Why a Progressive Web App?

Progressive Web Applications combine the reach of the web with native‑like features.  According to the Next.js PWA guide, PWAs allow developers to **deploy updates instantly, create cross‑platform applications with a single codebase and provide native‑like features such as home‑screen installation and push notifications**【232881519198629†L477-L492】.  A PWA is therefore ideal for YKVM’s use‑case where field staff often operate in areas with poor connectivity and need an installable mobile experience.  The provided `manifest.ts` defines the app’s name, icons and display mode【232881519198629†L498-L537】.

### Haversine Formula for Geofencing

Attendance is restricted to a geofence around an office location.  To compute the distance between the user’s GPS coordinates and the office, this app implements the **Haversine formula**.  The formula calculates the great‑circle distance between two points on a sphere based on their latitudes (`φ1`, `φ2`) and longitudes (`λ1`, `λ2`), using the Earth’s radius `r` (≈6 371 km) to compute the distance `d`【986412885831252†L120-L126】.  This ensures accurate geofence checks without calling external APIs.

### PDF & QR Code Generation

The system produces PDF documents for staff ID cards, salary slips, TA registers, movement registers and proceedings.  The `pdfkit` library is used to create complex multi‑page PDFs containing tables, images and logos.  A Next.js route calls helper functions in `src/lib/pdf.ts` to generate the appropriate files.  As noted in the LogRocket comparison of Node.js PDF libraries, **Puppeteer**, **jsPDF**, **PDFKit** and **pdfmake** are popular options【326515217162994†L88-L97】.  We chose **PDFKit** because it runs server‑side without needing a headless browser.  QR codes for staff ID cards are generated using the `qrcode` library.

## Features

The MIS covers every phase of staff management:

1. **Staff Enrollment & Onboarding** – Administrators create staff accounts with full personal details, documents, bank information and salary configuration.  Upon creation, a unique ID and ID card (with QR code) are generated.
2. **Authentication & RBAC** – Users sign in with email/phone and password via NextAuth.  Roles include **Admin**, **Sub‑Admin**, **Approver‑1**, **Approver‑2** and **Staff**, enforced via middleware on every API route.
3. **Attendance with Selfie & Geofence** – Staff mark attendance by capturing a selfie using the device camera and submitting GPS coordinates.  Attendance is accepted only if the user is within the configured geofence radius (default 10 m).  All submissions are logged in the AuditLog.
4. **Field Trips & Location Tracking** – Staff can start a field trip, which records the start time, location and optional odometer reading.  Location pings are recorded every 5 minutes while the trip is active.  When the trip ends, distance is computed using the Haversine formula and a travel allowance (TA) is calculated (₹3/km by default).  Administrators can view trips on a map.
5. **Activities & Proceedings** – During field trips staff upload at least five photos, a description, and an attendance sheet.  After submission, the system generates a structured proceedings PDF summarising work done, decisions, resolutions, attendees, challenges and outcomes.  Photos and signatures are embedded in the PDF.
6. **Leave Management** – Staff apply for paid/unpaid leave.  A two‑step approval workflow routes requests first to Approver‑1 and then to Approver‑2.  Approvers can approve or reject with comments.  Leave balances are maintained.
7. **Payroll & Salary Slips** – Monthly payroll is generated by computing pro‑rata salary based on attendance, paid leave and unpaid leave.  Salary slips include gross salary, deductions and net pay.  Administrators can mark salary as paid and record transaction references.  A TA register summarises kilometres travelled and TA amounts each month.
8. **Admin Dashboard & Registers** – Admins manage staff onboarding, office locations, geofence radius, leave approvals, field trip monitoring, activities, payroll and register downloads.  Movement and TA registers are exported as PDF.
9. **PWA & Offline Support** – A service worker caches core assets and implements a simple background sync queue for attendance submissions.  This allows staff to capture attendance offline and automatically sync when connectivity returns.  For more advanced PWA capabilities (push notifications, periodic background sync) you can extend the service worker following the Next.js guide【232881519198629†L547-L552】.
10. **Audit Logging** – Every critical action (attendance submission, leave application/approval, payroll generation, salary payment, field trip start/end, proceedings generation, office updates, profile updates) is recorded in the `AuditLog` model with timestamps and metadata for traceability.

## Tech Stack

| Layer        | Technology/Library                                           |
|-------------|---------------------------------------------------------------|
| **Frontend** | [Next.js](https://nextjs.org/) with the App Router, React, TypeScript, [Tailwind CSS](https://tailwindcss.com/) and [shadcn/ui](https://ui.shadcn.com/) components |
| **Backend**  | Next.js API routes (Node.js), [Prisma](https://prisma.io/) ORM, [NextAuth.js](https://next-auth.js.org/) authentication |
| **Database** | PostgreSQL managed via Prisma migrations                      |
| **Storage**  | Pluggable storage adapter interface with local filesystem (development) and S3‑compatible adapter for production |
| **PDFs**     | [PDFKit](https://pdfkit.org/) for server‑side PDF generation; [qrcode](https://github.com/soldair/node-qrcode) for QR codes |
| **PWA**      | Manifest + service worker implementing offline caching and basic background sync |

## Data Model

All entities are defined in `prisma/schema.prisma`.  Key models include:

- **User** – Authentication record with email/phone, hashed password and role.
- **StaffProfile** – HR details for each user (photo, designation, department, joining date, salary, bank details).  One‑to‑one relation with User.
- **StaffDocument** – Uploaded documents (type, file, verified flag).
- **OfficeLocation** – Office geofence centre (lat, lng, radius in metres, active flag).
- **Attendance** – Each attendance submission capturing timestamp, selfie file path, GPS coordinates, distance to office and status.
- **Leave** and **LeaveApproval** – Leave requests with two‑step approvals and status tracking.
- **FieldTrip**, **LocationPing** – Field trips with start/end, odometer readings, computed distance/TA and periodic location pings.
- **Activity**, **ActivityPhoto**, **AttendanceSheetUpload**, **Proceeding** – Activities during field trips, associated photos, attendance sheets and generated proceedings PDFs.
- **Payroll**, **SalaryPayment**, **TARegister** – Payroll records summarising salary and TA for each month, plus payment status.
- **AuditLog** – Generic audit log capturing user actions.

## Getting Started

### Prerequisites

* **Node.js 18+** and **npm** installed.
* **PostgreSQL** database running locally or remotely.  For development you can use Docker or a managed Postgres service.  When deploying to Vercel the platform can provision a Postgres instance automatically【734821837452312†L162-L160】.

### Installation

1. Clone the repository and install dependencies (this project lists dependencies in `package.json` but does not download them in this environment due to network restrictions; you should run the following commands locally):

   ```bash
   git clone https://github.com/ykvm/ykvm_staff_mis.git
   cd ykvm_staff_mis
   npm install
   ```

2. Copy `.env.example` to `.env` and fill in the environment variables.  You need to set `DATABASE_URL` pointing to your Postgres database, `NEXTAUTH_SECRET` (random string), and optional storage and VAPID keys.

3. Initialise Prisma and apply migrations:

   ```bash
   npx prisma generate
   npx prisma migrate dev --name init
   ```

4. Seed the database with a default admin user and office location:

   ```bash
   npm run seed
   ```

   The seed script prints the default admin credentials.  By default the admin user is `admin@ykvm.local` with password `admin123`.

5. Run the development server:

   ```bash
   npm run dev
   ```

   Open [http://localhost:3000](http://localhost:3000) to view the application.  You can sign in using the admin credentials created by the seed script.

### Running Tests

Unit tests are recommended for core business rules (geofence validation, payroll calculation, TA calculation).  The repository currently provides functions in `src/lib/geo.ts` and `src/lib/pdf.ts`; you can write tests using **Vitest** or **Jest** to validate them.  For brevity, tests are not included in this version.

## Deployment Guide

### Deploying on Vercel (Frontend & Backend)

1. Push the repository to GitHub.
2. Sign in to Vercel and import your GitHub repository.  Vercel automatically detects Next.js and configures the build.
3. In the **Storage** tab of your Vercel project, create a Postgres database.  Vercel will populate environment variables such as `POSTGRES_PRISMA_URL` and `POSTGRES_URL_NON_POOLING`【734821837452312†L162-L160】.  You can override `DATABASE_URL` to point at this database.
4. Configure environment variables in Vercel – copy values from your local `.env` into the Vercel dashboard.  At minimum set `NEXTAUTH_SECRET` and `JWT_SECRET`.
5. Trigger a deployment.  On first run, run the migration and seed commands via the **Vercel CLI** or manually:

   ```bash
   vercel env pull .env
   npx prisma migrate deploy
   npm run seed
   ```

6. After deployment the app will be available at `https://your-vercel-domain.vercel.app`.  Staff can install it to their home screen from supported browsers.

### Deploying Backend on Railway/Render

If you prefer to separate the backend from the frontend, you can deploy the Next.js API routes to Railway or Render:

1. Create a new **Node.js** project on Railway/Render and link your repository.
2. Provision a Postgres database in the platform and set `DATABASE_URL` accordingly.
3. Configure environment variables for NextAuth and storage.  Use the same build/start commands (`npm run build` then `npm start`).
4. For serving the frontend, you can still deploy the Next.js app on Vercel or host static exports on Cloudflare Pages.

### Cloudflare Pages + Workers (Optional)

Cloudflare Pages can host your static Next.js frontend while Cloudflare Workers or Pages Functions can run your API routes.  If you choose this route, you’ll need to bundle Prisma Client for Workers and connect to an external Postgres database.  This approach is more advanced and not covered here.

## Limitations & Future Enhancements

* **Offline Sync** – The provided service worker implements only basic caching and a naive background sync queue.  For full offline support you should implement an IndexedDB‑backed queue, use the **Background Sync API** and handle retry logic across page reloads.
* **Push Notifications** – Web push is not implemented.  The Next.js PWA guide explains how to register a service worker, generate VAPID keys and send notifications【232881519198629†L547-L552】.
* **UI/UX** – The current frontend uses simple HTML elements.  A production app should incorporate the shadcn/ui component library for polished forms, modals, tables and navigation.
* **Maps & Geofence Editing** – Admin dashboards should display maps (e.g. with Leaflet or Google Maps) for office configuration and field trip tracking.  This repository does not include those pages.
* **Uploads Validation** – File type and size validation is rudimentary.  Real deployments should validate MIME types, limit sizes and scan for viruses.
* **Advanced Payroll Rules** – The payroll module performs simple pro‑rata calculations.  Future versions should support allowances, taxes, deductions and generate bank batch files.
* **Notifications Integration** – Email and WhatsApp notifications are implemented as no‑op placeholders.  Integrate real providers when keys are available.

## Key API Routes

Below is a high‑level overview of the most important API endpoints and their RBAC requirements.  All routes enforce authentication and roles via middleware or inline checks.

| Route                                   | Method | Description | Role |
|----------------------------------------|-------|-------------|------|
| `/api/auth/[...nextauth]`               | GET/POST | NextAuth handlers (login, callback, session) | Public |
| `/api/staff`                            | POST  | Create new staff profile with user account | Admin, Sub‑Admin |
| `/api/attendance`                       | POST  | Submit attendance with selfie + GPS | Staff |
| `/api/leave`                            | GET   | List current user’s leaves | Authenticated |
| `/api/leave`                            | POST  | Apply for leave | Staff |
| `/api/leave?id=<id>`                    | PATCH | Approve or reject leave | Approver‑1/Approver‑2 |
| `/api/field?action=start`               | POST  | Start a field trip | Staff |
| `/api/field?id=<id>&action=end`         | PATCH | End a field trip and compute distance/TA | Staff |
| `/api/activity`                         | GET   | List activities (optional filter by fieldTripId) | Authenticated |
| `/api/activity`                         | POST  | Create an activity with photos and attendance sheet | Staff |
| `/api/payroll`                          | GET   | Retrieve payroll records (staff see their own) | Authenticated |
| `/api/payroll/generate`                 | POST  | Generate payroll for specified month/year | Admin, Sub‑Admin |
| `/api/payroll/pay?id=<id>`              | PATCH | Mark a payroll record as paid | Admin, Sub‑Admin |

> **Note:** Additional routes (e.g. for document management, office location management, map views, register generation and notifications) should be implemented following the same patterns.

## Admin Credentials (Seed)

After running `npm run seed` the script creates a default admin user:

- **Email:** `admin@ykvm.local`
- **Password:** `admin123`

You should change this password immediately after the first login.  Use the admin dashboard (to be implemented) to create additional approvers and staff accounts.

## Conclusion

This repository lays the foundation for a comprehensive staff MIS tailored to YKVM’s requirements.  It demonstrates how to structure a Next.js application with Prisma, NextAuth, PDF generation and PWA capabilities.  While many advanced features (maps, background sync, notifications) require further work, the core business rules and data models are in place.  Contributions and pull requests to enhance the user interface, add tests and extend functionality are welcome.